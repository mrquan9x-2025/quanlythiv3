<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Thi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chart.js (Bi·ªÉu ƒë·ªì) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (Xu·∫•t Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; font-size: 14px; }
        .sidebar { height: 100vh; overflow-y: auto; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .exam-list-container { flex-grow: 1; overflow-y: auto; }
        .exam-item { cursor: pointer; padding: 12px 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .exam-item:hover, .exam-item.active { background-color: #e9ecef; border-left: 5px solid #0d6efd; }
        .table-container { overflow: auto; max-height: 70vh; position: relative; border: 1px solid #dee2e6; min-height: 200px;}
        th, td { text-align: center; vertical-align: middle; white-space: nowrap; padding: 6px !important; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #212529 !important; }
        
        /* C·∫§U H√åNH STICKY (C·ªê ƒê·ªäNH) */
        /* 1. C·ªôt H·ªç t√™n & ƒêi·ªÉm */
        .sticky-col-1 { position: sticky; left: 0; z-index: 10; background-color: #f8f9fa; border-right: 1px solid #dee2e6; min-width: 160px; text-align: left; }
        .sticky-col-2 { position: sticky; left: 160px; z-index: 10; background-color: #f8f9fa; border-right: 2px solid #dee2e6; min-width: 60px; }
        
        /* 2. D√≤ng Ti√™u ƒë·ªÅ (Header) - Top: 0. Cao: 50px */
        thead th { position: sticky; top: 0; z-index: 20; background-color: #343a40; color: white; height: 50px;}
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 30; }

        /* 3. D√≤ng T·ªà L·ªÜ SAI (D√≤ng 2) - Top: 50px. Cao: 30px (Thu g·ªçn) */
        .sticky-row-stats { position: sticky; top: 50px; z-index: 15; background-color: #fff3cd; font-weight: bold; border-bottom: 1px solid #ccc; height: 30px; font-size: 0.85rem; }
        .sticky-row-stats td.sticky-col-1, .sticky-row-stats td.sticky-col-2 { background-color: #fff3cd; z-index: 25; }

        /* 4. D√≤ng ƒê√ÅP √ÅN (D√≤ng 3) - Top: 80px (50+30). Cao: 30px. M√†u #cffce6 */
        .sticky-row-key { position: sticky; top: 80px; z-index: 15; background-color: #cffce6; font-weight: bold; color: #0d6efd; border-bottom: 2px solid #999; height: 30px; font-size: 0.85rem; }
        /* T√¥ m√†u #cffce6 cho c·∫£ d√≤ng v√† c√°c √¥ c·ªë ƒë·ªãnh */
        .sticky-row-key td, .sticky-row-key td.sticky-col-1, .sticky-row-key td.sticky-col-2 { background-color: #cffce6 !important; z-index: 25; }

        .cell-correct { background-color: #ffffff !important; color: #198754; } 
        .cell-wrong { background-color: #ffe6e6 !important; color: #dc3545; }
        .overview-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-box { text-align: center; border-right: 1px solid #eee; }
        .stat-box:last-child { border-right: none; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #0d6efd; }
        .stat-label { font-size: 0.85rem; color: #6c757d; }
        .analysis-section { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px; }
        .question-badge { font-size: 0.85rem; margin-right: 5px; margin-bottom: 5px; display: inline-block; padding: 5px 10px; }
        .easy-text { color: #6c757d; font-size: 0.9rem; line-height: 1.6; }
        
        .item-analysis-table th { background-color: #e9ecef; color: #333; vertical-align: middle; }
        .bad-question { background-color: #ffe6e6; } 
        .good-question { background-color: #d1e7dd; } 

        .page-footer { margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; text-align: center; font-size: 0.9rem; color: #6c757d; }
        .page-footer a { color: #0d6efd; text-decoration: none; font-weight: 500; }
        .page-footer a:hover { text-decoration: underline; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        @media (max-width: 768px) {
            .sidebar { height: auto; max-height: 250px; border-bottom: 2px solid #ccc; }
            .sticky-col-2 { left: 100px; min-width: 50px; } 
            .sticky-col-1 { min-width: 100px; font-size: 12px;}
            td, th { font-size: 12px; padding: 4px !important; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 class="fw-bold text-primary">ƒêang t·∫£i danh s√°ch ƒë·ªÅ...</h5>
        <p id="error-msg" class="text-danger mt-3 fw-bold"></p>
    </div>

    <div id="dashboard" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3 bg-dark text-white fw-bold">QU·∫¢N L√ù THI</div>
                <div class="p-2 border-bottom">
                    <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="T√¨m m√£ ƒë·ªÅ ho·∫∑c t√™n ƒë·ªÅ..." onkeyup="filterExamList()">
                </div>
                <div id="exam-list" class="exam-list-container">
                    <p class="text-center mt-3 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 p-3" style="height: 100vh; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="current-exam-title" class="fw-bold text-primary m-0">Ch·ªçn ƒë·ªÅ thi ƒë·ªÉ xem k·∫øt qu·∫£</h5>
                    <!-- Khu v·ª±c c√°c n√∫t ch·ª©c nƒÉng -->
                    <div id="action-buttons" class="d-none">
                         <button onclick="refreshCurrentData()" class="btn btn-success btn-sm me-1" title="T·∫£i l·∫°i d·ªØ li·ªáu m·ªõi nh·∫•t">üîÑ</button>
                         <button onclick="showAdvancedStats()" class="btn btn-info btn-sm me-1 text-white">üìà Th·ªëng k√™</button>
                         <button onclick="showItemAnalysis()" class="btn btn-warning btn-sm me-1">üîç Ph√¢n t√≠ch</button>
                         <button onclick="showChart()" class="btn btn-primary btn-sm">üìä Ph·ªï ƒëi·ªÉm</button>
                    </div>
                </div>

                <!-- T·ªïng quan r√∫t g·ªçn -->
                <div id="overview-section" class="d-none">
                    <div class="overview-card">
                        <div class="row mb-2">
                            <div class="col-3 stat-box"><div class="stat-value" id="stat-count">0</div><div class="stat-label">Th√≠ sinh</div></div>
                            <div class="col-3 stat-box"><div class="stat-value" id="stat-avg">0</div><div class="stat-label">ƒêi·ªÉm TB</div></div>
                            <div class="col-3 stat-box"><div class="stat-value text-success" id="stat-max">0</div><div class="stat-label">Cao nh·∫•t</div></div>
                            <div class="col-3 stat-box"><div class="stat-value text-danger" id="stat-min">0</div><div class="stat-label">Th·∫•p nh·∫•t</div></div>
                        </div>
                        <div class="analysis-section row">
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-success small text-uppercase">D·ªÖ (Sai < 30%)</h6>
                                <div id="list-easy" class="easy-text"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-warning small text-uppercase" style="color:#fd7e14!important">Trung b√¨nh (30-70%)</h6>
                                <div id="list-medium"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-danger small text-uppercase">Kh√≥ (Sai > 70%)</h6>
                                <div id="list-hard"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="main-content" class="table-container shadow-sm bg-white rounded position-relative">
                </div>

                <!-- FOOTER & N√öT XU·∫§T EXCEL -->
                <div id="footer-actions" class="d-none mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <button onclick="exportStudentList()" class="btn btn-outline-success fw-bold">
                            üì• Xu·∫•t b·∫£ng ƒëi·ªÉm (.xlsx)
                        </button>
                        <div class="page-footer">
                            Design by <a href="https://www.facebook.com/quanptq" target="_blank">Ph·∫°m Th·∫ø Qu√¢n</a> @ 2025
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- C√ÅC MODAL (CHART, STATS, ITEM ANALYSIS) GI·ªÆ NGUY√äN NH∆Ø C≈® -->
    <!-- MODAL 1: BI·ªÇU ƒê·ªí -->
    <div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title fw-bold">üìä Ph·ªï ƒëi·ªÉm thi</h5><button type="button" class="btn-close" onclick="closeModal('chartModal')"></button></div>
                <div class="modal-body"><canvas id="scoreChart"></canvas></div>
            </div>
        </div>
    </div>
    <!-- MODAL 2: TH·ªêNG K√ä -->
    <div class="modal fade" id="statsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white"><h5 class="modal-title fw-bold">üìà C√°c ch·ªâ s·ªë th·ªëng k√™</h5><button type="button" class="btn-close" onclick="closeModal('statsModal')"></button></div>
                <div class="modal-body">
                    <table class="table table-striped">
                        <tbody>
                            <tr><td>T·ªïng s·ªë th√≠ sinh</td><td class="fw-bold text-end" id="st-count"></td></tr>
                            <tr><td>ƒêi·ªÉm trung b√¨nh (Mean)</td><td class="fw-bold text-end" id="st-mean"></td></tr>
                            <tr><td>Trung v·ªã (Median)</td><td class="fw-bold text-end" id="st-median"></td></tr>
                            <tr><td>M·ªët (Mode)</td><td class="fw-bold text-end" id="st-mode"></td></tr>
                            <tr><td>ƒê·ªô l·ªách chu·∫©n (SD)</td><td class="fw-bold text-end" id="st-sd"></td></tr>
                            <tr><td>ƒêi·ªÉm th·∫•p nh·∫•t (Min)</td><td class="fw-bold text-end text-danger" id="st-min-val"></td></tr>
                            <tr><td>ƒêi·ªÉm cao nh·∫•t (Max)</td><td class="fw-bold text-end text-success" id="st-max-val"></td></tr>
                            <tr><td>T·ª© ph√¢n v·ªã th·ª© nh·∫•t (Q1)</td><td class="fw-bold text-end" id="st-q1"></td></tr>
                            <tr><td>T·ª© ph√¢n v·ªã th·ª© ba (Q3)</td><td class="fw-bold text-end" id="st-q3"></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL 3: PH√ÇN T√çCH -->
    <div class="modal fade" id="itemAnalysisModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold">üîç Ph√¢n t√≠ch ch·∫•t l∆∞·ª£ng c√¢u h·ªèi (27% Group)</h5>
                    <button type="button" class="btn-close" onclick="closeModal('itemAnalysisModal')"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="alert alert-light border small mb-0 p-2 flex-grow-1 me-2">
                            <strong>Ch√∫ gi·∫£i:</strong><br>
                            - <strong>ƒê·ªô kh√≥ (P):</strong> T·ªâ l·ªá ƒë√∫ng. P > 0.7 (D·ªÖ), 0.3-0.7 (TB), < 0.3 (Kh√≥).<br>
                            - <strong>ƒê·ªô ph√¢n bi·ªát (D):</strong> Ph√¢n lo·∫°i Gi·ªèi/Y·∫øu. D >= 0.4 (R·∫•t t·ªët), 0.3-0.4 (T·ªët), 0.2-0.3 (Ch·∫•p nh·∫≠n), < 0.2 (K√©m).
                        </div>
                        <button onclick="exportItemAnalysis()" class="btn btn-success text-nowrap">üì• Xu·∫•t b√°o c√°o</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm text-center item-analysis-table">
                            <thead>
                                <tr>
                                    <th>C√¢u</th>
                                    <th>Nh√≥m Cao (H)<br><small id="h-count"></small></th>
                                    <th>Nh√≥m Th·∫•p (L)<br><small id="l-count"></small></th>
                                    <th>ƒê·ªô kh√≥ (P)</th>
                                    <th>M·ª©c ƒë·ªô</th>
                                    <th>ƒê·ªô ph√¢n bi·ªát (D)</th>
                                    <th>ƒê√°nh gi√°</th>
                                </tr>
                            </thead>
                            <tbody id="item-analysis-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrijo6SO5gMM5u7Adr24IaUA7_UoDmb5GKHzNWABLZ-tIK1Fr6FyOpEmX_8Xa4h2pc/exec"; 
        const AUTO_PASS = "123@456";
        // ================

        let examList = [];       
        let currentStudents = []; 
        let currentExam = null; 
        let currentConfig = {};   
        let sortState = { col: null, dir: 'asc' };
        let myChart = null;
        let examCache = {}; 

        window.onload = function() { loadExamList(); };

        function parseScore(str) { return !str ? 0 : parseFloat(String(str).replace(',', '.')); }
        function getName(fullName) { if (!fullName) return ""; const parts = fullName.trim().split(" "); return parts[parts.length - 1].toLowerCase(); }

        // --- C√ÅC H√ÄM X·ª¨ L√ù MODAL ---
        function showModal(id) { const modal = new bootstrap.Modal(document.getElementById(id)); modal.show(); }
        function closeModal(id) { const el = document.getElementById(id); const modal = bootstrap.Modal.getInstance(el); if (modal) modal.hide(); }

        async function loadExamList() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getExamList&pass=${AUTO_PASS}&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) document.getElementById('error-msg').innerText = "L·ªói: " + data.error;
                else {
                    examList = data.exams;
                    document.getElementById('loading-overlay').classList.add('d-none');
                    document.getElementById('dashboard').classList.remove('d-none');
                    renderExamList();
                }
            } catch (err) { console.error(err); document.getElementById('error-msg').innerText = "Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!"; }
        }

        async function loadStudentData(exam, forceUpdate = false) {
            const container = document.getElementById('main-content');
            container.innerHTML = `<div class="d-flex justify-content-center align-items-center" style="height: 200px;"><div class="spinner-border text-primary"></div></div>`;

            if (!forceUpdate && examCache[exam.maDe]) {
                currentStudents = examCache[exam.maDe];
                if (currentStudents.length === 0) handleEmptyData();
                else renderUI(currentStudents, exam.configJson);
                return; 
            }

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentList&pass=${AUTO_PASS}&maDe=${exam.maDe}&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) alert("L·ªói t·∫£i d·ªØ li·ªáu HS: " + data.error); 
                else {
                    examCache[exam.maDe] = data.students;
                    currentStudents = data.students;
                    if (currentStudents.length === 0) handleEmptyData();
                    else renderUI(currentStudents, exam.configJson);
                }
            } catch (err) { console.error(err); alert("L·ªói k·∫øt n·ªëi khi t·∫£i d·ªØ li·ªáu HS"); }
        }

        function handleEmptyData() {
            document.getElementById('main-content').innerHTML = '<p class="text-center p-4 text-muted">Ch∆∞a c√≥ d·ªØ li·ªáu thi.</p>';
            document.getElementById('overview-section').classList.add('d-none'); 
            document.getElementById('action-buttons').classList.add('d-none'); 
            document.getElementById('footer-actions').classList.add('d-none'); 
        }

        function renderUI(students, configJson) {
            try { currentConfig = JSON.parse(configJson); } catch(e) { currentConfig = {}; }
            calculateOverview(students, currentConfig);
            renderMatrixTable(students, currentConfig);
            document.getElementById('overview-section').classList.remove('d-none'); 
            document.getElementById('action-buttons').classList.remove('d-none'); 
            document.getElementById('footer-actions').classList.remove('d-none'); 
        }

        function refreshCurrentData() {
            if (currentExam) { delete examCache[currentExam.maDe]; loadStudentData(currentExam, true); }
        }

        // --- LOGIC PH√ÇN LO·∫†I & HI·ªÇN TH·ªä T·ªîNG QUAN ---
        function calculateOverview(students, config) {
            const section = document.getElementById('overview-section');
            if(students.length === 0) { section.classList.add('d-none'); return; }
            const scores = students.map(s => parseScore(s.diem));
            const count = students.length;
            const max = Math.max(...scores); const min = Math.min(...scores);
            const sum = scores.reduce((a, b) => a + b, 0); const avg = (sum / count).toFixed(2);
            document.getElementById('stat-count').innerText = count; document.getElementById('stat-avg').innerText = avg.replace('.', ',');
            document.getElementById('stat-max').innerText = max.toString().replace('.', ','); document.getElementById('stat-min').innerText = min.toString().replace('.', ',');
            
            const questions = config.dapAn || [];
            let easyArr = [], mediumArr = [], hardArr = [];
            
            questions.forEach(q => {
                let wrongCount = 0;
                students.forEach(hs => {
                    let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) {}
                    const ans = baiLam.find(c => c.cau == q.id);
                    let isCorrect = false;
                    if (ans) {
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if (!isCorrect) wrongCount++;
                });
                
                // --- S·ª¨A CH·ªÆA: L√ÄM TR√íN TR∆Ø·ªöC KHI SO S√ÅNH ---
                let wrongPercent = count > 0 ? Math.round((wrongCount / count) * 100) : 0;
                let item = { id: q.id, val: wrongPercent };

                if (wrongPercent < 30) easyArr.push(item);
                else if (wrongPercent <= 70) mediumArr.push(item);
                else hardArr.push(item);
            });

            // S·∫Øp x·∫øp
            easyArr.sort((a,b) => a.val - b.val);
            mediumArr.sort((a,b) => a.val - b.val);
            hardArr.sort((a,b) => a.val - b.val);

            // Render HTML
            let htmlEasy = easyArr.map(i => `C${i.id} (${i.val}%)`).join(", ");
            let htmlMedium = mediumArr.map(i => `<span class="badge bg-warning text-dark question-badge">C${i.id} (${i.val}%)</span>`).join("");
            let htmlHard = hardArr.map(i => `<span class="badge bg-danger question-badge">C${i.id} (${i.val}%)</span>`).join("");

            document.getElementById('list-easy').innerText = htmlEasy || "Kh√¥ng c√≥";
            document.getElementById('list-medium').innerHTML = htmlMedium || '<span class="text-muted small">Kh√¥ng c√≥</span>';
            document.getElementById('list-hard').innerHTML = htmlHard || '<span class="text-muted small">Kh√¥ng c√≥</span>';
        }

        // --- PH√ÇN T√çCH C√ÇU H·ªéI (ƒê·ªíNG B·ªò LOGIC) ---
        function showItemAnalysis() {
            if (currentStudents.length === 0) return;
            const questions = currentConfig.dapAn || [];
            if (questions.length === 0) { alert("Kh√¥ng c√≥ th√¥ng tin ƒë√°p √°n."); return; }

            let sortedStudents = [...currentStudents].sort((a, b) => parseScore(b.diem) - parseScore(a.diem));
            const total = sortedStudents.length;
            const groupSize = Math.round(total * 0.27);
            
            if (groupSize === 0) { alert("S·ªë l∆∞·ª£ng h·ªçc sinh qu√° √≠t ƒë·ªÉ ph√¢n t√≠ch."); return; }
            
            const highGroup = sortedStudents.slice(0, groupSize);
            const lowGroup = sortedStudents.slice(total - groupSize, total);

            document.getElementById('h-count').innerText = `(n=${groupSize})`;
            document.getElementById('l-count').innerText = `(n=${groupSize})`;

            let html = "";
            questions.forEach(q => {
                const rHigh = countCorrect(highGroup, q);
                const rLow = countCorrect(lowGroup, q);
                const rTotal = countCorrect(sortedStudents, q);

                const p = rTotal / total; // ƒê·ªô kh√≥ (0-1)
                const d = (rHigh - rLow) / groupSize; // ƒê·ªô ph√¢n bi·ªát
                
                // --- S·ª¨A CH·ªÆA: ƒê·ªíNG B·ªò LOGIC V·ªöI T·ªîNG QUAN ---
                // T√≠nh % Sai (ƒë√£ l√†m tr√≤n) ƒë·ªÉ ph√¢n lo·∫°i
                let wPercent = Math.round((1 - p) * 100);
                
                let pLabel = "", pClass = "";
                if (wPercent < 30) { pLabel = "D·ªÖ"; pClass = "text-success"; } // P > 0.7
                else if (wPercent <= 70) { pLabel = "Trung b√¨nh"; pClass = "text-warning"; } // 0.3 <= P <= 0.7
                else { pLabel = "Kh√≥"; pClass = "text-danger"; } // P < 0.3

                let dLabel = "", dClass = "", rowClass = "";
                if (d >= 0.4) { dLabel = "R·∫•t t·ªët"; dClass = "text-success fw-bold"; rowClass = "good-question"; }
                else if (d >= 0.3) { dLabel = "T·ªët"; dClass = "text-primary"; }
                else if (d >= 0.2) { dLabel = "Ch·∫•p nh·∫≠n"; dClass = "text-secondary"; }
                else { dLabel = "K√©m/C·∫ßn s·ª≠a"; dClass = "text-danger fw-bold"; rowClass = "bad-question"; }

                html += `<tr class="${rowClass}">
                    <td class="fw-bold">C${q.id}</td>
                    <td>${rHigh}/${groupSize}</td>
                    <td>${rLow}/${groupSize}</td>
                    <td><b class="${pClass}">${p.toFixed(2)}</b></td>
                    <td class="small ${pClass}">${pLabel}</td>
                    <td><b class="${dClass}">${d.toFixed(2)}</b></td>
                    <td class="small ${dClass}">${dLabel}</td>
                </tr>`;
            });
            document.getElementById('item-analysis-body').innerHTML = html;
            showModal('itemAnalysisModal');
        }

        function renderMatrixTable(students, examConfig) {
            const container = document.getElementById('main-content');
            if (students.length === 0) { container.innerHTML = '<p class="text-center p-4">Ch∆∞a c√≥ d·ªØ li·ªáu thi.</p>'; return; }
            const questions = examConfig.dapAn || [];
            let statsCorrectCount = new Array(questions.length).fill(0);

            // T√≠nh th·ªëng k√™
            students.forEach(hs => {
                let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) { baiLam = []; }
                questions.forEach((q, index) => {
                    const ans = baiLam.find(c => c.cau == q.id);
                    let isCorrect = false;
                    if (ans) {
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if(isCorrect) statsCorrectCount[index]++;
                });
            });

            let html = '<table class="table table-bordered table-hover mb-0">';
            let iconName = sortState.col === 'name' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï';
            let iconScore = sortState.col === 'score' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï';
            
            // 1. Header
            html += `<thead><tr><th class="sticky-col-1 sortable" onclick="sortTable('name')">H·ªç v√† T√™n <span class="sort-icon">${iconName}</span></th><th class="sticky-col-2 sortable" onclick="sortTable('score')">ƒêi·ªÉm <span class="sort-icon">${iconScore}</span></th>`;
            questions.forEach(q => { html += `<th>C${q.id}</th>`; });
            html += '</tr></thead><tbody>';

            // 2. D√≤ng T·ªà L·ªÜ SAI (ƒê∆∞a l√™n tr∆∞·ªõc) - Class sticky-row-stats
            html += '<tr class="sticky-row-stats"><td class="sticky-col-1 text-danger">T·ªâ l·ªá sai</td><td class="sticky-col-2"></td>';
            const totalStudents = students.length;
            questions.forEach((q, index) => {
                let wrongPercent = 0; if (totalStudents > 0) wrongPercent = 100 - ((statsCorrectCount[index] / totalStudents) * 100);
                let colorClass = wrongPercent > 50 ? "text-danger fw-bold" : "text-dark";
                html += `<td class="text-center ${colorClass}">${Math.round(wrongPercent)}%</td>`;
            });
            html += '</tr>';

            // 3. D√≤ng ƒê√ÅP √ÅN (ƒê∆∞a xu·ªëng sau) - Class sticky-row-key
            html += '<tr class="sticky-row-key"><td class="sticky-col-1">ƒê√°p √°n</td><td class="sticky-col-2"></td>';
            questions.forEach(q => {
                let keyDisplay = "";
                if (q.dang == 2 && Array.isArray(q.dapAn)) {
                    keyDisplay = q.dapAn.map(b => b ? "ƒê" : "S").join("");
                } else {
                    keyDisplay = q.dapAn;
                }
                html += `<td class="text-center">${keyDisplay}</td>`;
            });
            html += '</tr>';

            // 4. Danh s√°ch HS
            students.forEach(hs => {
                let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) { baiLam = []; }
                let diemHienThi = hs.diem; 
                html += `<tr><td class="sticky-col-1 fw-bold text-start ps-2">${hs.hoTen}</td><td class="sticky-col-2 text-primary fw-bold">${diemHienThi}</td>`;
                questions.forEach((q, index) => {
                    const ans = baiLam.find(c => c.cau == q.id);
                    let display = ""; let cssClass = "cell-wrong"; let isCorrect = false;
                    if (ans) {
                        if (q.dang == 2 && Array.isArray(ans.chon)) display = ans.chon.map(val => val === true ? "ƒê" : "S").join(""); else display = ans.chon;
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if (isCorrect) cssClass = "cell-correct";
                    html += `<td class="${cssClass}">${display}</td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // --- C√ÅC H√ÄM PH·ª§ TR·ª¢ KH√ÅC GI·ªÆ NGUY√äN (Export, Stats, Chart, CountCorrect...) ---
        function exportStudentList() {
            if (currentStudents.length === 0) return;
            const questions = currentConfig.dapAn || [];
            let data = currentStudents.map(s => {
                let baiLam = []; try { baiLam = JSON.parse(s.baiLamJson); } catch(e) {}
                let row = { "M√£ ƒë·ªÅ": s.maDe, "H·ªç v√† T√™n": s.hoTen, "ƒêi·ªÉm": s.diem };
                questions.forEach(q => {
                    const ans = baiLam.find(c => c.cau == q.id);
                    let display = "";
                    if (ans) { if (q.dang == 2 && Array.isArray(ans.chon)) display = ans.chon.map(val => val === true ? "ƒê" : "S").join(""); else display = ans.chon; }
                    row[`C√¢u ${q.id}`] = display;
                });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "BangDiem"); XLSX.writeFile(wb, `BangDiem_${currentExam.maDe}.xlsx`);
        }
        function exportItemAnalysis() {
            if (currentStudents.length === 0) return;
            const questions = currentConfig.dapAn || [];
            let sortedStudents = [...currentStudents].sort((a, b) => parseScore(b.diem) - parseScore(a.diem));
            const total = sortedStudents.length; const groupSize = Math.round(total * 0.27);
            const highGroup = sortedStudents.slice(0, groupSize); const lowGroup = sortedStudents.slice(total - groupSize, total);
            let data = questions.map(q => {
                const rHigh = countCorrect(highGroup, q); const rLow = countCorrect(lowGroup, q); const rTotal = countCorrect(sortedStudents, q);
                const p = rTotal / total; const d = groupSize > 0 ? (rHigh - rLow) / groupSize : 0;
                let wPercent = Math.round((1 - p) * 100);
                let mucDo = ""; if (wPercent < 30) mucDo = "D·ªÖ"; else if (wPercent <= 70) mucDo = "Trung b√¨nh"; else mucDo = "Kh√≥";
                return { "C√¢u": q.id, "Nh√≥m Cao (H)": rHigh, "Nh√≥m Th·∫•p (L)": rLow, "T·ªïng ƒê√∫ng": rTotal, "ƒê·ªô kh√≥ (P)": p.toFixed(3), "M·ª©c ƒë·ªô": mucDo, "ƒê·ªô ph√¢n bi·ªát (D)": d.toFixed(3) };
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "PhanTichCauHoi"); XLSX.writeFile(wb, `PhanTich_${currentExam.maDe}.xlsx`);
        }
        function showAdvancedStats() {
            if (currentStudents.length === 0) return;
            let scores = currentStudents.map(s => parseScore(s.diem)).sort((a, b) => a - b);
            const n = scores.length; const sum = scores.reduce((a, b) => a + b, 0); const mean = sum / n;
            let median = 0; if (n % 2 === 0) median = (scores[n/2 - 1] + scores[n/2]) / 2; else median = scores[Math.floor(n/2)];
            let frequency = {}; let maxFreq = 0; scores.forEach(val => { frequency[val] = (frequency[val] || 0) + 1; if (frequency[val] > maxFreq) maxFreq = frequency[val]; });
            let modes = []; for (let key in frequency) { if (frequency[key] === maxFreq && maxFreq > 1) modes.push(key); }
            let modeStr = modes.length > 0 ? modes.join(", ") : "Kh√¥ng c√≥";
            const variance = scores.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n; const sd = Math.sqrt(variance);
            document.getElementById('st-count').innerText = n; document.getElementById('st-mean').innerText = mean.toFixed(2);
            document.getElementById('st-median').innerText = median.toFixed(2); document.getElementById('st-mode').innerText = modeStr + (modes.length > 0 ? ` (${maxFreq} l·∫ßn)` : "");
            document.getElementById('st-sd').innerText = sd.toFixed(2); document.getElementById('st-min-val').innerText = scores[0]; document.getElementById('st-max-val').innerText = scores[n-1];
            document.getElementById('st-q1').innerText = quantile(scores, 0.25); document.getElementById('st-q3').innerText = quantile(scores, 0.75);
            showModal('statsModal');
        }
        function quantile(sorted, q) { const pos = (sorted.length - 1) * q; const base = Math.floor(pos); const rest = pos - base; if (sorted[base + 1] !== undefined) return (sorted[base] + rest * (sorted[base + 1] - sorted[base])).toFixed(2); else return sorted[base].toFixed(2); }
        function showChart() {
            if (currentStudents.length === 0) return;
            let distribution = new Array(10).fill(0); currentStudents.forEach(hs => { let s = parseScore(hs.diem); let index = Math.floor(s); if (index >= 10) index = 9; distribution[index]++; });
            const ctx = document.getElementById('scoreChart'); if (myChart) myChart.destroy();
            myChart = new Chart(ctx, { type: 'bar', data: { labels: ['0-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10'], datasets: [{ label: 'S·ªë l∆∞·ª£ng h·ªçc sinh', data: distribution, backgroundColor: 'rgba(13, 110, 253, 0.7)', borderColor: 'rgba(13, 110, 253, 1)', borderWidth: 1 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            showModal('chartModal');
        }
        function countCorrect(group, question) { let count = 0; group.forEach(hs => { let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) {} const ans = baiLam.find(c => c.cau == question.id); if (ans) { if (question.dang == 1 || question.dang == 3) { if (String(ans.chon) == String(question.dapAn)) count++; } else if (question.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(question.dapAn)) count++; } } }); return count; }
        
        // --- C√ÅC H√ÄM KH√ÅC GI·ªÆ NGUY√äN (renderExamList, filterExamList, selectExam, sortTable...) ---
        function renderExamList(keyword = "") {
            const listContainer = document.getElementById('exam-list'); listContainer.innerHTML = "";
            let filteredExams = [...examList].reverse();
            if (keyword) { const lowerKey = keyword.toLowerCase(); filteredExams = filteredExams.filter(e => String(e.maDe).toLowerCase().includes(lowerKey) || String(e.tenDe).toLowerCase().includes(lowerKey)); }
            if(filteredExams.length === 0) { listContainer.innerHTML = '<p class="text-center mt-3 text-muted small">Kh√¥ng t√¨m th·∫•y</p>'; return; }
            filteredExams.forEach(exam => { const div = document.createElement('div'); div.className = "exam-item"; div.innerHTML = `<div class="fw-bold text-primary">${exam.maDe}</div><div class="small text-muted text-truncate">${exam.tenDe}</div>`; div.onclick = () => selectExam(exam, div); listContainer.appendChild(div); });
        }
        function filterExamList() { renderExamList(document.getElementById('searchBox').value); }
        function selectExam(exam, element) {
            document.querySelectorAll('.exam-item').forEach(el => el.classList.remove('active')); element.classList.add('active');
            document.getElementById('current-exam-title').innerText = `${exam.maDe} - ${exam.tenDe}`;
            currentExam = exam;
            document.getElementById('overview-section').classList.add('d-none'); document.getElementById('action-buttons').classList.add('d-none'); document.getElementById('footer-actions').classList.add('d-none');
            sortState = { col: null, dir: 'asc' }; loadStudentData(exam);
        }
        function sortTable(column) {
            if (sortState.col === column) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc'; else { sortState.col = column; sortState.dir = 'asc'; }
            currentStudents.sort((a, b) => { let valA, valB; if (column === 'name') { valA = getName(a.hoTen); valB = getName(b.hoTen); return sortState.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); } else if (column === 'score') { valA = parseScore(a.diem); valB = parseScore(b.diem); return sortState.dir === 'asc' ? valA - valB : valB - valA; } });
            renderMatrixTable(currentStudents, currentConfig);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
