<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; font-size: 14px; }
        .sidebar { height: 100vh; overflow-y: auto; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .exam-list-container { flex-grow: 1; overflow-y: auto; }
        .exam-item { cursor: pointer; padding: 12px 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .exam-item:hover, .exam-item.active { background-color: #e9ecef; border-left: 5px solid #0d6efd; }
        .table-container { overflow: auto; max-height: 70vh; position: relative; border: 1px solid #dee2e6; min-height: 200px;}
        th, td { text-align: center; vertical-align: middle; white-space: nowrap; padding: 6px !important; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background-color: #212529 !important; }
        .sticky-col-1 { position: sticky; left: 0; z-index: 10; background-color: #f8f9fa; border-right: 1px solid #dee2e6; min-width: 160px; text-align: left; }
        .sticky-col-2 { position: sticky; left: 160px; z-index: 10; background-color: #f8f9fa; border-right: 2px solid #dee2e6; min-width: 60px; }
        thead th { position: sticky; top: 0; z-index: 20; background-color: #343a40; color: white; height: 50px;}
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 30; }
        .sticky-row-stats { position: sticky; top: 50px; z-index: 15; background-color: #fff3cd; font-weight: bold; border-bottom: 2px solid #999; }
        .sticky-row-stats td.sticky-col-1, .sticky-row-stats td.sticky-col-2 { background-color: #fff3cd; z-index: 25; }
        .cell-correct { background-color: #ffffff !important; color: #198754; } 
        .cell-wrong { background-color: #ffe6e6 !important; color: #dc3545; }
        .overview-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-box { text-align: center; border-right: 1px solid #eee; }
        .stat-box:last-child { border-right: none; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: #0d6efd; }
        .stat-label { font-size: 0.85rem; color: #6c757d; }
        .analysis-section { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 15px; }
        /* Style ri√™ng cho badge c·∫£nh b√°o */
        .question-badge { font-size: 0.85rem; margin-right: 5px; margin-bottom: 5px; display: inline-block; padding: 5px 10px; }
        /* Style cho text c√¢u d·ªÖ */
        .easy-text { color: #6c757d; font-size: 0.9rem; line-height: 1.6; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .local-loading { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display:flex; justify-content:center; align-items:center; z-index: 50; }
        
        @media (max-width: 768px) {
            .sidebar { height: auto; max-height: 250px; border-bottom: 2px solid #ccc; }
            .sticky-col-2 { left: 100px; min-width: 50px; } 
            .sticky-col-1 { min-width: 100px; font-size: 12px;}
            td, th { font-size: 12px; padding: 4px !important; }
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 class="fw-bold text-primary">ƒêang t·∫£i danh s√°ch ƒë·ªÅ...</h5>
        <small class="text-muted">Design by Qu√¢nPT</small>
        <p id="error-msg" class="text-danger mt-3 fw-bold"></p>
    </div>

    <div id="dashboard" class="container-fluid d-none">
        <div class="row">
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3 bg-dark text-white fw-bold">QU·∫¢N L√ù THI</div>
                <div class="p-2 border-bottom">
                    <input type="text" id="searchBox" class="form-control form-control-sm" placeholder="T√¨m m√£ ƒë·ªÅ ho·∫∑c t√™n ƒë·ªÅ..." onkeyup="filterExamList()">
                </div>
                <div id="exam-list" class="exam-list-container">
                    <p class="text-center mt-3 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
            </div>

            <div class="col-md-9 col-lg-10 p-3" style="height: 100vh; overflow-y: auto;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="current-exam-title" class="fw-bold text-primary m-0">Ch·ªçn ƒë·ªÅ thi ƒë·ªÉ xem k·∫øt qu·∫£</h5>
                    <div>
                         <button onclick="showChart()" class="btn btn-outline-primary btn-sm me-2 d-none" id="btnShowChart">üìä Xem ph·ªï ƒëi·ªÉm</button>
                    </div>
                </div>

                <div id="overview-section" class="d-none">
                    <div class="overview-card">
                        <div class="row mb-2">
                            <div class="col-3 stat-box"><div class="stat-value" id="stat-count">0</div><div class="stat-label">Th√≠ sinh</div></div>
                            <div class="col-3 stat-box"><div class="stat-value" id="stat-avg">0</div><div class="stat-label">ƒêi·ªÉm TB</div></div>
                            <div class="col-3 stat-box"><div class="stat-value text-success" id="stat-max">0</div><div class="stat-label">Cao nh·∫•t</div></div>
                            <div class="col-3 stat-box"><div class="stat-value text-danger" id="stat-min">0</div><div class="stat-label">Th·∫•p nh·∫•t</div></div>
                        </div>
                        <div class="analysis-section row">
                            <!-- C√¢u D·ªÖ: Li·ªát k√™ text -->
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-success small text-uppercase">D·ªÖ (Sai ‚â§ 30%)</h6>
                                <div id="list-easy" class="easy-text"></div>
                            </div>
                            <!-- C√¢u TB/Kh√≥: Gi·ªØ nguy√™n Badge -->
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-warning small text-uppercase" style="color:#fd7e14!important">Trung b√¨nh (30-70%)</h6>
                                <div id="list-medium"></div>
                            </div>
                            <div class="col-md-4 mb-2">
                                <h6 class="fw-bold text-danger small text-uppercase">Kh√≥ (Sai ‚â• 70%)</h6>
                                <div id="list-hard"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="main-content" class="table-container shadow-sm bg-white rounded position-relative">
                    <div id="table-loading" class="local-loading d-none">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Bi·ªÉu ƒë·ªì -->
    <div class="modal fade" id="chartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">üìä Ph·ªï ƒëi·ªÉm thi</h5>
                    <button type="button" class="btn-close" onclick="closeChartModal()"></button>
                </div>
                <div class="modal-body">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === C·∫§U H√åNH ===
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrijo6SO5gMM5u7Adr24IaUA7_UoDmb5GKHzNWABLZ-tIK1Fr6FyOpEmX_8Xa4h2pc/exec"; 
        const AUTO_PASS = "123@456";
        // ================

        let examList = [];       
        let currentStudents = []; 
        let currentConfig = {};   
        let sortState = { col: null, dir: 'asc' };
        let myChart = null;

        window.onload = function() { loadExamList(); };

        function parseScore(str) { return !str ? 0 : parseFloat(String(str).replace(',', '.')); }
        function getName(fullName) { if (!fullName) return ""; const parts = fullName.trim().split(" "); return parts[parts.length - 1].toLowerCase(); }

        async function loadExamList() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getExamList&pass=${AUTO_PASS}&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) {
                    document.getElementById('error-msg').innerText = "L·ªói: " + data.error;
                } else {
                    examList = data.exams;
                    document.getElementById('loading-overlay').classList.add('d-none');
                    document.getElementById('dashboard').classList.remove('d-none');
                    renderExamList();
                }
            } catch (err) {
                console.error(err);
                document.getElementById('error-msg').innerText = "Kh√¥ng th·ªÉ k·∫øt n·ªëi Server!";
            }
        }

        async function loadStudentData(exam) {
            const tableLoader = document.getElementById('table-loading');
            tableLoader.classList.remove('d-none');
            document.getElementById('main-content').innerHTML = '<div id="table-loading" class="local-loading"><div class="spinner-border text-primary"></div></div>'; 

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getStudentList&pass=${AUTO_PASS}&maDe=${exam.maDe}&t=${new Date().getTime()}`);
                const data = await response.json();
                if (data.error) { alert("L·ªói t·∫£i d·ªØ li·ªáu HS: " + data.error); } 
                else {
                    currentStudents = data.students;
                    calculateOverview(currentStudents, currentConfig);
                    renderMatrixTable(currentStudents, currentConfig);
                    document.getElementById('btnShowChart').classList.remove('d-none');
                }
            } catch (err) { console.error(err); alert("L·ªói k·∫øt n·ªëi khi t·∫£i d·ªØ li·ªáu HS"); }
        }

        function renderExamList(keyword = "") {
            const listContainer = document.getElementById('exam-list');
            listContainer.innerHTML = "";
            let filteredExams = [...examList].reverse();
            if (keyword) {
                const lowerKey = keyword.toLowerCase();
                filteredExams = filteredExams.filter(e => 
                    String(e.maDe).toLowerCase().includes(lowerKey) || 
                    String(e.tenDe).toLowerCase().includes(lowerKey)
                );
            }
            if(filteredExams.length === 0) { listContainer.innerHTML = '<p class="text-center mt-3 text-muted small">Kh√¥ng t√¨m th·∫•y</p>'; return; }
            filteredExams.forEach(exam => {
                const div = document.createElement('div');
                div.className = "exam-item";
                div.innerHTML = `<div class="fw-bold text-primary">${exam.maDe}</div><div class="small text-muted text-truncate">${exam.tenDe}</div>`;
                div.onclick = () => selectExam(exam, div);
                listContainer.appendChild(div);
            });
        }

        function filterExamList() { renderExamList(document.getElementById('searchBox').value); }

        function selectExam(exam, element) {
            document.querySelectorAll('.exam-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('current-exam-title').innerText = `${exam.maDe} - ${exam.tenDe}`;
            document.getElementById('overview-section').classList.add('d-none');
            document.getElementById('btnShowChart').classList.add('d-none');
            
            sortState = { col: null, dir: 'asc' };
            try { currentConfig = JSON.parse(exam.configJson); } catch(e) { currentConfig = {}; }
            loadStudentData(exam);
        }

        function sortTable(column) {
            if (sortState.col === column) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
            else { sortState.col = column; sortState.dir = 'asc'; }
            currentStudents.sort((a, b) => {
                let valA, valB;
                if (column === 'name') { valA = getName(a.hoTen); valB = getName(b.hoTen); return sortState.dir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA); } 
                else if (column === 'score') { valA = parseScore(a.diem); valB = parseScore(b.diem); return sortState.dir === 'asc' ? valA - valB : valB - valA; }
            });
            renderMatrixTable(currentStudents, currentConfig);
        }

        function calculateOverview(students, config) {
            const section = document.getElementById('overview-section');
            if(students.length === 0) { section.classList.add('d-none'); return; }
            section.classList.remove('d-none');

            const scores = students.map(s => parseScore(s.diem));
            const count = students.length;
            const max = Math.max(...scores);
            const min = Math.min(...scores);
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = (sum / count).toFixed(2);

            document.getElementById('stat-count').innerText = count;
            document.getElementById('stat-avg').innerText = avg.replace('.', ',');
            document.getElementById('stat-max').innerText = max.toString().replace('.', ',');
            document.getElementById('stat-min').innerText = min.toString().replace('.', ',');

            const questions = config.dapAn || [];
            let listEasy = [], listMedium = [], listHard = [];
            questions.forEach(q => {
                let wrongCount = 0;
                students.forEach(hs => {
                    let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) {}
                    const ans = baiLam.find(c => c.cau == q.id);
                    let isCorrect = false;
                    if (ans) {
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if (!isCorrect) wrongCount++;
                });
                let wrongPercent = count > 0 ? (wrongCount / count) * 100 : 0;
                
                // LOGIC PH√ÇN LO·∫†I M·ªöI
                if (wrongPercent <= 30) {
                    // D·ªÖ: Ch·ªâ l·∫•y t√™n c√¢u, kh√¥ng badge
                    listEasy.push(`C${q.id}`);
                } else if (wrongPercent < 70) {
                    // TB: Badge v√†ng
                    listMedium.push(`<span class="badge bg-warning text-dark question-badge">C${q.id} (${Math.round(wrongPercent)}%)</span>`);
                } else {
                    // Kh√≥: Badge ƒë·ªè
                    listHard.push(`<span class="badge bg-danger question-badge">C${q.id} (${Math.round(wrongPercent)}%)</span>`);
                }
            });

            // Hi·ªÉn th·ªã listEasy n·ªëi chu·ªói b·∫±ng d·∫•u ph·∫©y
            document.getElementById('list-easy').innerText = listEasy.length ? listEasy.join(", ") : "Kh√¥ng c√≥";
            document.getElementById('list-medium').innerHTML = listMedium.length ? listMedium.join("") : '<span class="text-muted small">Kh√¥ng c√≥</span>';
            document.getElementById('list-hard').innerHTML = listHard.length ? listHard.join("") : '<span class="text-muted small">Kh√¥ng c√≥</span>';
        }

        function renderMatrixTable(students, examConfig) {
            const container = document.getElementById('main-content');
            if (students.length === 0) { container.innerHTML = '<p class="text-center p-4">Ch∆∞a c√≥ d·ªØ li·ªáu thi.</p>'; return; }

            const questions = examConfig.dapAn || [];
            let statsCorrectCount = new Array(questions.length).fill(0);

            students.forEach(hs => {
                let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) { baiLam = []; }
                questions.forEach((q, index) => {
                    const ans = baiLam.find(c => c.cau == q.id);
                    let isCorrect = false;
                    if (ans) {
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if(isCorrect) statsCorrectCount[index]++;
                });
            });

            let html = '<table class="table table-bordered table-hover mb-0">';
            let iconName = sortState.col === 'name' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï';
            let iconScore = sortState.col === 'score' ? (sortState.dir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï';
            html += `<thead><tr><th class="sticky-col-1 sortable" onclick="sortTable('name')">H·ªç v√† T√™n <span class="sort-icon">${iconName}</span></th><th class="sticky-col-2 sortable" onclick="sortTable('score')">ƒêi·ªÉm <span class="sort-icon">${iconScore}</span></th>`;
            questions.forEach(q => { html += `<th>C${q.id}</th>`; });
            html += '</tr></thead><tbody>';
            html += '<tr class="sticky-row-stats"><td class="sticky-col-1 text-danger">T·ªâ l·ªá sai</td><td class="sticky-col-2"></td>';
            const totalStudents = students.length;
            questions.forEach((q, index) => {
                let wrongPercent = 0; if (totalStudents > 0) wrongPercent = 100 - ((statsCorrectCount[index] / totalStudents) * 100);
                let colorClass = wrongPercent > 50 ? "text-danger fw-bold" : "text-dark";
                html += `<td class="text-center ${colorClass}">${Math.round(wrongPercent)}%</td>`;
            });
            html += '</tr>';
            students.forEach(hs => {
                let baiLam = []; try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) { baiLam = []; }
                let diemHienThi = hs.diem; 
                html += `<tr><td class="sticky-col-1 fw-bold text-start ps-2">${hs.hoTen}</td><td class="sticky-col-2 text-primary fw-bold">${diemHienThi}</td>`;
                questions.forEach((q, index) => {
                    const ans = baiLam.find(c => c.cau == q.id);
                    let display = ""; let cssClass = "cell-wrong"; let isCorrect = false;
                    if (ans) {
                        if (q.dang == 2 && Array.isArray(ans.chon)) display = ans.chon.map(val => val === true ? "ƒê" : "S").join(""); else display = ans.chon;
                        if (q.dang == 1 || q.dang == 3) { if (String(ans.chon) == String(q.dapAn)) isCorrect = true; } 
                        else if (q.dang == 2) { if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true; }
                    }
                    if (isCorrect) cssClass = "cell-correct";
                    html += `<td class="${cssClass}">${display}</td>`;
                });
                html += `</tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showChart() {
            if (currentStudents.length === 0) return;
            let distribution = new Array(10).fill(0);
            currentStudents.forEach(hs => {
                let s = parseScore(hs.diem);
                let index = Math.floor(s); if (index >= 10) index = 9; distribution[index]++;
            });
            const ctx = document.getElementById('scoreChart');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6-7', '7-8', '8-9', '9-10'],
                    datasets: [{ label: 'S·ªë l∆∞·ª£ng h·ªçc sinh', data: distribution, backgroundColor: 'rgba(13, 110, 253, 0.7)', borderColor: 'rgba(13, 110, 253, 1)', borderWidth: 1 }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
            document.getElementById('chartModal').classList.add('show');
            document.getElementById('chartModal').style.display = 'block';
            document.body.classList.add('modal-open');
            let backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            backdrop.id = 'chartBackdrop';
            document.body.appendChild(backdrop);
        }
        function closeChartModal() {
            document.getElementById('chartModal').classList.remove('show');
            document.getElementById('chartModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            let backdrop = document.getElementById('chartBackdrop'); if(backdrop) backdrop.remove();
        }
    </script>
</body>
</html>
