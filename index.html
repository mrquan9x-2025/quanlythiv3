<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Thi</title>
    <!-- Thư viện Bootstrap 5 (Giao diện) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font chữ Google -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; }
        
        /* Màn hình đăng nhập */
        #login-screen {
            height: 100vh; display: flex; align-items: center; justify-content: center;
        }

        /* Giao diện chính */
        .sidebar {
            height: 100vh; overflow-y: auto; background: white; border-right: 1px solid #ddd;
        }
        .exam-item { cursor: pointer; padding: 15px; border-bottom: 1px solid #eee; transition: 0.2s; }
        .exam-item:hover, .exam-item.active { background-color: #e9ecef; border-left: 5px solid #0d6efd; }
        
        /* Bảng thống kê Matrix */
        .table-container { overflow-x: auto; max-height: 80vh; position: relative; }
        th, td { text-align: center; vertical-align: middle; white-space: nowrap; padding: 8px !important; }
        
        /* Cố định cột Họ tên và Cột Điểm */
        .sticky-col-1 { position: sticky; left: 0; z-index: 10; background-color: #f8f9fa; border-right: 2px solid #dee2e6; }
        .sticky-col-2 { position: sticky; left: 150px; z-index: 10; background-color: #f8f9fa; border-right: 2px solid #dee2e6; }
        thead th { position: sticky; top: 0; z-index: 20; background-color: #343a40; color: white; }
        thead th.sticky-col-1, thead th.sticky-col-2 { z-index: 30; }

        /* Màu sắc kết quả */
        .cell-correct { background-color: #ffffff; color: #198754; font-weight: bold; } /* Trắng */
        .cell-wrong { background-color: #ffe6e6; color: #dc3545; } /* Đỏ nhạt */
        
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .sidebar { height: auto; max-height: 200px; border-bottom: 2px solid #ccc; }
            .sticky-col-2 { left: 100px; } /* Thu hẹp khoảng cách trên mobile */
            td, th { font-size: 12px; padding: 4px !important; }
        }
    </style>
</head>
<body>

    <!-- 1. Màn hình Đăng nhập -->
    <div id="login-screen">
        <div class="card p-4 shadow" style="width: 350px;">
            <h4 class="text-center mb-3">Đăng Nhập Quản Trị</h4>
            <input type="password" id="passwordInput" class="form-control mb-3" placeholder="Nhập mật khẩu...">
            <button onclick="login()" class="btn btn-primary w-100" id="btnLogin">Truy cập</button>
            <p id="loginMsg" class="text-danger mt-2 text-center small"></p>
        </div>
    </div>

    <!-- 2. Màn hình Dashboard (Ẩn lúc đầu) -->
    <div id="dashboard" class="container-fluid d-none">
        <div class="row">
            <!-- Cột trái: Danh sách Mã đề -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3 bg-dark text-white fw-bold">DANH SÁCH ĐỀ</div>
                <div id="exam-list">
                    <!-- Danh sách đề sẽ được JS chèn vào đây -->
                    <p class="text-center mt-3 text-muted">Đang tải dữ liệu...</p>
                </div>
            </div>

            <!-- Cột phải: Chi tiết Thống kê -->
            <div class="col-md-9 col-lg-10 p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 id="current-exam-title" class="fw-bold text-primary">Vui lòng chọn đề thi bên trái</h5>
                    <button onclick="exportExcel()" class="btn btn-success btn-sm d-none" id="btnExport">Xuất Excel</button>
                </div>
                
                <div id="main-content" class="table-container shadow-sm bg-white rounded">
                    <!-- Bảng kết quả sẽ hiện ở đây -->
                </div>
            </div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script>
        // === CẤU HÌNH ===
        // HÃY DÁN LINK WEB APP CỦA BẠN VÀO GIỮA DẤU NHÁY DƯỚI ĐÂY
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrijo6SO5gMM5u7Adr24IaUA7_UoDmb5GKHzNWABLZ-tIK1Fr6FyOpEmX_8Xa4h2pc/exec";
        // ================

        let globalData = null; // Lưu toàn bộ dữ liệu tải về

        // Hàm Đăng nhập
        async function login() {
            const pass = document.getElementById('passwordInput').value;
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('loginMsg');
            
            if(!pass) return;
            
            btn.innerHTML = "Đang kết nối...";
            btn.disabled = true;
            msg.innerText = "";

            try {
                // Gọi sang Google Apps Script
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAdminData&pass=${pass}`);
                const data = await response.json();

                if (data.error) {
                    msg.innerText = data.error;
                    btn.innerHTML = "Truy cập";
                    btn.disabled = false;
                } else {
                    // Đăng nhập thành công
                    globalData = data;
                    document.getElementById('login-screen').classList.add('d-none');
                    document.getElementById('dashboard').classList.remove('d-none');
                    renderExamList();
                }
            } catch (err) {
                console.error(err);
                msg.innerText = "Lỗi kết nối! Kiểm tra mạng hoặc Link Script.";
                btn.innerHTML = "Truy cập";
                btn.disabled = false;
            }
        }

        // Hàm hiển thị danh sách đề bên trái
        function renderExamList() {
            const listContainer = document.getElementById('exam-list');
            listContainer.innerHTML = "";
            
            // Đảo ngược để đề mới nhất lên đầu
            [...globalData.exams].reverse().forEach(exam => {
                const div = document.createElement('div');
                div.className = "exam-item";
                div.innerHTML = `
                    <div class="fw-bold">${exam.maDe}</div>
                    <div class="small text-muted text-truncate">${exam.tenDe}</div>
                `;
                div.onclick = () => selectExam(exam, div);
                listContainer.appendChild(div);
            });
        }

        // Hàm xử lý khi chọn 1 đề thi
        function selectExam(exam, element) {
            // Highlight mục được chọn
            document.querySelectorAll('.exam-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            document.getElementById('current-exam-title').innerText = `${exam.maDe} - ${exam.tenDe}`;
            
            // Lọc học sinh thi mã đề này
            const students = globalData.students.filter(hs => hs.maDe == exam.maDe);
            
            // Parse config đề để biết cấu trúc câu hỏi
            let config = {};
            try { config = JSON.parse(exam.configJson); } catch(e) { console.log("Lỗi parse config đề"); }
            
            renderMatrixTable(students, config);
        }

        // Hàm chính: Vẽ bảng Ma trận
        function renderMatrixTable(students, examConfig) {
            const container = document.getElementById('main-content');
            if (students.length === 0) {
                container.innerHTML = '<p class="text-center p-4">Chưa có học sinh nào thi mã đề này.</p>';
                return;
            }

            // Lấy danh sách đáp án đúng từ config để dựng cột
            // Config mẫu: { dapAn: [ {id:1, dang:1...}, ... ] }
            const questions = examConfig.dapAn || [];
            
            // Chuẩn bị tính toán thống kê (Mảng đếm số câu đúng cho từng câu hỏi)
            let statsCorrectCount = new Array(questions.length + 1).fill(0); // Index từ 1 cho dễ

            let html = '<table class="table table-bordered table-hover mb-0">';
            
            // --- HEADER ---
            html += '<thead><tr>';
            html += '<th class="sticky-col-1" style="min-width:150px">Họ và Tên</th>';
            html += '<th class="sticky-col-2" style="min-width:60px">Điểm</th>';
            
            questions.forEach(q => {
                let label = `C${q.id}`;
                let sub = q.dang == 2 ? "(Đ/S)" : "";
                html += `<th>${label}<br><small style="font-size:9px; font-weight:normal">${sub}</small></th>`;
            });
            html += '</tr></thead>';

            // --- BODY ---
            html += '<tbody>';
            
            students.forEach(hs => {
                let baiLam = [];
                try { baiLam = JSON.parse(hs.baiLamJson); } catch(e) { baiLam = []; }

                html += `<tr>`;
                html += `<td class="sticky-col-1 fw-bold">${hs.hoTen}</td>`;
                html += `<td class="sticky-col-2 text-danger fw-bold">${hs.diem}</td>`;

                // Duyệt qua từng câu hỏi trong đề gốc để tìm câu trả lời tương ứng của HS
                questions.forEach((q, index) => {
                    // Tìm câu trả lời trong bài làm của HS khớp với id câu hỏi
                    const ans = baiLam.find(c => c.cau == q.id);
                    
                    let display = "-";
                    let cssClass = "";
                    let isCorrect = false;

                    if (ans) {
                        // 1. Xử lý hiển thị nội dung
                        if (q.dang == 2) { 
                            // Dạng Đúng/Sai: Mảng [true, false...] -> "ĐS..."
                            // ans.chon là mảng boolean
                            if (Array.isArray(ans.chon)) {
                                display = ans.chon.map(val => val === true ? "Đ" : "S").join(""); 
                            } else {
                                display = "Lỗi"; 
                            }
                        } else {
                            // Dạng 1 & 3: Hiển thị trực tiếp
                            display = ans.chon;
                        }

                        // 2. Xử lý Màu sắc (Logic: Điểm đạt == Điểm Max của câu thì Trắng, khác thì Đỏ)
                        // Cần tính điểm max của câu này.
                        // Trong bài làm (ans) thường có ans.diem (điểm hs đạt được).
                        // Ta cần biết điểm max. Giả sử Config có p1_score (điểm mỗi câu phần 1).
                        // Tuy nhiên đơn giản nhất: So sánh ans.diem với điểm tối đa lý thuyết.
                        // Theo yêu cầu của bạn: Đúng hoàn toàn mới tính là đúng.
                        
                        // Để đơn giản và chính xác với logic "Khắt khe" bạn yêu cầu:
                        // Dạng 2: Phải đúng cả 4 ý mới là đúng.
                        // Dạng 1,3: Chọn đúng đáp án là đúng.
                        
                        // Chúng ta dựa vào `ans.ketQua`. 
                        // Trong JSON mẫu bạn gửi: Dạng 1 kqua="Đúng". Dạng 2 kqua=[true, false...].
                        
                        // Logic tô màu bạn yêu cầu: 
                        // Đúng hoàn toàn (Max điểm) -> Nền Trắng (class cell-correct).
                        // Sai hoặc thiếu ý -> Nền Đỏ (class cell-wrong).

                        // Cách check Max điểm tối ưu nhất dựa trên dữ liệu bạn có:
                        // Nếu là Dạng 1,3: ans.ketQua == "Đúng"
                        // Nếu là Dạng 2: ans.chon (mảng HS) so sánh khớp hoàn toàn với q.dapAn (mảng Key)
                        
                        // Tuy nhiên, check nhanh bằng điểm số:
                        // Nếu ans.diem > 0.9 (coi như 1 điểm - hoặc điểm max) -> Trắng.
                        // Nhưng đề có thể 0.25đ. 
                        
                        // => Giải pháp: Dùng JSON Đề (q.dapAn) để so sánh đáp án HS chọn (ans.chon)
                        
                        if (q.dang == 1 || q.dang == 3) {
                             // So sánh lỏng (để tránh lỗi kiểu số/chuỗi)
                             if (String(ans.chon) == String(q.dapAn)) isCorrect = true;
                        } else if (q.dang == 2) {
                             // So sánh 2 mảng
                             // q.dapAn là [true, false...] (Key)
                             // ans.chon là [true, false...] (HS)
                             if (JSON.stringify(ans.chon) === JSON.stringify(q.dapAn)) isCorrect = true;
                        }

                        if (isCorrect) {
                            cssClass = "cell-correct";
                            statsCorrectCount[index]++; // Cộng vào thống kê
                        } else {
                            cssClass = "cell-wrong";
                        }
                    }

                    html += `<td class="${cssClass}">${display}</td>`;
                });

                html += `</tr>`;
            });

            // --- HÀNG THỐNG KÊ (CUỐI CÙNG) ---
            html += '<tr class="bg-warning fw-bold border-top border-dark">';
            html += '<td class="sticky-col-1">Tỉ lệ đúng</td>';
            html += '<td class="sticky-col-2"></td>';
            
            const totalStudents = students.length;
            questions.forEach((q, index) => {
                let percent = 0;
                if (totalStudents > 0) {
                    percent = (statsCorrectCount[index] / totalStudents) * 100;
                }
                html += `<td class="text-center">${Math.round(percent)}%</td>`;
            });
            html += '</tr>';

            html += '</tbody></table>';
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>